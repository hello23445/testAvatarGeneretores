<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>О API - Image Generator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: linear-gradient(135deg, #74ABE2, #5563DE); 
            color: #fff; 
        }
        h1, h2 { color: #fff; }
        table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; word-wrap: break-word; }
        th { background-color: #f2f2f2; color: #333; }
        pre { 
            background: #f4f4f4; 
            padding: 10px; 
            border-radius: 5px; 
            overflow: auto; 
            color: #333; 
            position: relative; 
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        button { 
            padding: 10px 20px; 
            background-color: #4CAF50; 
            color: white; 
            border: none; 
            cursor: pointer; 
            border-radius: 5px; 
        }
        #apiInfo { display: none; }
        #createButton { display: none; }
        #status { margin-top: 10px; color: #fff; }
        #error { margin-top: 10px; color: red; }
        .copy-btn { 
            background: #4CAF50; 
            border: none; 
            cursor: pointer; 
            font-size: 16px; 
            margin-left: 10px; 
            color: #fff; 
            white-space: nowrap;
            padding: 5px 10px;
            border-radius: 5px;
        }
        #loader { 
            display: none; 
            position: fixed; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            border: 16px solid #f3f3f3; 
            border-top: 16px solid #3498db; 
            border-radius: 50%; 
            width: 60px; 
            height: 60px; 
            animation: spin 2s linear infinite; 
        }
        #notification {
            display: none;
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
            text-align: center;
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        @media (max-width: 600px) { 
            body { margin: 10px; font-size: 14px; } 
            h1 { font-size: 20px; }
            h2 { font-size: 16px; }
            table { font-size: 12px; }
            th, td { padding: 4px; }
            pre { font-size: 10px; padding: 5px; }
            button { padding: 8px 16px; font-size: 14px; }
            .copy-btn { font-size: 14px; margin-left: 5px; padding: 4px 8px; }
        }
        h2 { display: flex; align-items: center; flex-wrap: wrap; }
    </style>
</head>
<body>
    <button onclick="window.location.href='index.html'">Вернуться назад</button>

    <h1 style="color: black;">Информация об CrN PhotoAI API</h1>

    <div id="loader"></div>
    <div id="notification"></div>

    <div id="apiCreation">
        <p id="createButton"><button id="createApiBtn">Создать мой API</button></p>
        <p id="status"></p>
        <p id="error"></p>
    </div>

    <div id="apiInfo">
        <h2>Ваш API ключ<button class="copy-btn" onclick="copyToClipboard('apiKeyPre')" title="Нажмите чтобы скопировать."><i class="fa-solid fa-copy"></i> Скопировать</button></h2>
        <pre id="apiKeyPre"><span class="code-text"></span></pre>

        <h2>URL-Адрес запроса<button class="copy-btn" onclick="copyToClipboard('requestUrl')" title="Нажмите чтобы скопировать."><i class="fa-solid fa-copy"></i> Скопировать</button></h2>
        <pre id="requestUrl"><span class="code-text">https://script.google.com/macros/s/AKfycbyPkqHhHjM4Ub4Fp2f2XRxWipau1zwXUJv6XoSzTbrgpJa80UspoVZjJy67GX_nGVjueg/exec</span></pre>

        <h2>Параметры запроса</h2>
        <table>
            <tr><th>Поле</th><th>Описание</th><th>Тип</th></tr>
            <tr><td>api_key</td><td>Ваш API ключ.</td><td>Обязательный.</td></tr>
            <tr><td>photo_description</td><td>Описание фото.</td><td>Обязательный.</td></tr>
            <tr><td>width</td><td>Ширина фото<br>По-умолчанию 512px(пикселей).</td><td>Необязательный.</td></tr>
            <tr><td>height</td><td>Длина фото<br>По-умолчанию 512px(пикселей).</td><td>Необязательный.</td></tr>
        </table>

        <h2>Готовый запрос для вас<button class="copy-btn" onclick="copyToClipboard('readyRequest')" title="Нажмите чтобы скопировать."><i class="fa-solid fa-copy"></i> Скопировать</button></h2>
        <pre id="readyRequest"><span class="code-text"></span></pre>

        <h2>Готовый fetch-запрос для вас<button class="copy-btn" onclick="copyToClipboard('fetchRequest')" title="Нажмите чтобы скопировать."><i class="fa-solid fa-copy"></i> Скопировать</button></h2>
        <pre id="fetchRequest"><span class="code-text"></span></pre>

        <h2>Пример успешного ответа<button class="copy-btn" onclick="copyToClipboard('successExample')" title="Нажмите чтобы скопировать."><i class="fa-solid fa-copy"></i> Скопировать</button></h2>
        <pre id="successExample"><span class="code-text">{
  "status": "success",
  "data": "iVBORw0KGgoAAAANSUhEUgAAAgAAAAIACAYAAAD0eNT6AAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB+QLEg4bJ... (длинная Base64-строка)",
  "mime": "image/png"
}</span></pre>

        <h2>Пример неуспешного ответа<button class="copy-btn" onclick="copyToClipboard('errorExample')" title="Нажмите чтобы скопировать."><i class="fa-solid fa-copy"></i> Скопировать</button></h2>
        <pre id="errorExample"><span class="code-text">{
  "status": "error",
  "message": "Invalid api_key"
}</span></pre>

        <h2>Когда поле photo_description или api_key не заполнено<button class="copy-btn" onclick="copyToClipboard('missingParamsExample')" title="Нажмите чтобы скопировать."><i class="fa-solid fa-copy"></i> Скопировать</button></h2>
        <pre id="missingParamsExample"><span class="code-text">{
  "status": "error",
  "message": "Missing required parameters: api_key and photo_description"
}</span></pre>

        <h2>Когда api_key неверный<button class="copy-btn" onclick="copyToClipboard('invalidKeyExample')" title="Нажмите чтобы скопировать."><i class="fa-solid fa-copy"></i> Скопировать</button></h2>
        <pre id="invalidKeyExample"><span class="code-text">{
  "status": "error",
  "message": "Invalid api_key"
}</span></pre>

        <h2>Когда дневные лимиты закончились<button class="copy-btn" onclick="copyToClipboard('limitExample')" title="Нажмите чтобы скопировать."><i class="fa-solid fa-copy"></i> Скопировать</button></h2>
        <pre id="limitExample"><span class="code-text">{
  "status": "error",
  "message": "No limit available"
}</span></pre>

        <p>Ваш текущий лимит: <span id="currentLimit"></span><br>Лимиты обновляются каждый день.<br>Вы бесплатно получаете 20 лимитов в сутки, а с Premium — 50 лимитов в сутки.</p>
    </div>

    <script>
        const gasUrl = 'https://script.google.com/macros/s/AKfycbyPkqHhHjM4Ub4Fp2f2XRxWipau1zwXUJv6XoSzTbrgpJa80UspoVZjJy67GX_nGVjueg/exec';
        const createBtn = document.getElementById('createApiBtn');
        const apiInfo = document.getElementById('apiInfo');
        const createButtonDiv = document.getElementById('createButton');
        const statusP = document.getElementById('status');
        const errorP = document.getElementById('error');
        const readyRequest = document.getElementById('readyRequest');
        const fetchRequest = document.getElementById('fetchRequest');
        const currentLimitSpan = document.getElementById('currentLimit');
        const apiKeyPre = document.getElementById('apiKeyPre');
        const loader = document.getElementById('loader');
        const notification = document.getElementById('notification');

        function showLoader(show) {
            loader.style.display = show ? 'block' : 'none';
        }

        function showNotification(message, color = '#4CAF50') {
            notification.textContent = message;
            notification.style.background = color;
            notification.style.display = 'block';
            setTimeout(() => { notification.style.display = 'none'; }, 3000);
        }

        function copyToClipboard(elementId) {
            const pre = document.getElementById(elementId);
            const text = pre.querySelector('.code-text').textContent;
            const btn = document.querySelector(`[onclick="copyToClipboard('${elementId}')"]`);
            const originalContent = btn.innerHTML;

            navigator.clipboard.writeText(text).then(() => {
                btn.innerHTML = '<i class="fa-solid fa-check"></i> Скопировано!';
                setTimeout(() => { btn.innerHTML = originalContent; }, 2000);
            }).catch(err => {
                btn.innerHTML = '<i class="fa-solid fa-xmark"></i> Произошла ошибка при копировании.';
                setTimeout(() => { btn.innerHTML = originalContent; }, 2000);
                console.error('Ошибка копирования: ', err);
            });
        }

        async function checkApiKey() {
            const hasApi = localStorage.getItem('hasApi');
            const token = localStorage.getItem('user_Token');
            if (hasApi !== 'true' || !token) {
                createButtonDiv.style.display = 'block';
                return;
            }

            apiKeyPre.querySelector('.code-text').textContent = token;
            readyRequest.querySelector('.code-text').textContent = `curl -X POST '${gasUrl}' \\\n     -d 'api_key=${token}' \\\n     -d 'photo_description=A beautiful sunset over the mountains' \\\n     -d 'width=1024' \\\n     -d 'height=768'`;
            fetchRequest.querySelector('.code-text').textContent = `fetch('${gasUrl}', {\n  method: 'POST',\n  body: new URLSearchParams({\n    api_key: '${token}',\n    photo_description: 'A beautiful sunset over the mountains',\n    width: '1024',\n    height: '768'\n  })\n}).then(response => response.json()).then(data => console.log(data));`;

            apiInfo.style.display = 'block';

            // Fetch limit without initial loader if hasApi
            const params = new URLSearchParams({ action: 'check', api_key: token });
            try {
                const response = await fetch(gasUrl, { method: 'POST', body: params });
                const data = await response.json();
                if (data.status === 'success') {
                    currentLimitSpan.textContent = data.limit;
                } else {
                    errorP.textContent = 'Ошибка получения лимита: ' + data.message;
                }
            } catch (err) {
                errorP.textContent = 'Ошибка проверки: ' + err.message;
            }
        }

        createBtn.addEventListener('click', async () => {
            showLoader(true);
            let token = localStorage.getItem('user_Token');
            if (!token) {
                token = crypto.randomUUID();
                localStorage.setItem('user_Token', token);
            }
            const premium = localStorage.getItem('premium') === 'true';

            const params = new URLSearchParams({ action: 'create', api_key: token, premium: premium });
            try {
                const response = await fetch(gasUrl, { method: 'POST', body: params });
                const data = await response.json();
                if (data.status === 'success') {
                    localStorage.setItem('hasApi', 'true');
                    statusP.textContent = 'API ключ создан успешно!';
                    createButtonDiv.style.display = 'none';
                    checkApiKey(); // Refresh info
                } else {
                    errorP.textContent = 'Ошибка создания: ' + data.message;
                }
            } catch (err) {
                errorP.textContent = 'Ошибка: ' + err.message;
            } finally {
                showLoader(false);
            }
        });

        checkApiKey();
    </script>
</body>
</html>